{% extends "base.html" %}
{% block title %}ë°ì´í„° ì…ë ¥ - ë¡œë˜ ë¶„ì„{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ“ ë°ì´í„° ì…ë ¥</h1>
    <p>ë‹¹ì²¨ ë²ˆí˜¸ì™€ ê° ì½”ë“œì˜ ì˜ˆì¸¡ ë²ˆí˜¸ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤</p>
</div>

<div class="grid-2">
    <!-- ë‹¹ì²¨ ë²ˆí˜¸ ì…ë ¥ -->
    <div class="card">
        <div class="card-title"><i class="fas fa-dice"></i> Step 1: ë‹¹ì²¨ ë²ˆí˜¸ ë“±ë¡</div>
        <form action="/input/round" method="POST">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                <div class="form-group">
                    <label class="form-label">íšŒì°¨ ë²ˆí˜¸</label>
                    <input type="number" name="round_number" required min="1" placeholder="1210">
                </div>
                <div class="form-group">
                    <label class="form-label">ì¶”ì²¨ì¼</label>
                    <input type="date" name="draw_date">
                </div>
            </div>

            <label class="form-label" style="margin-top:0.5rem">ë‹¹ì²¨ ë²ˆí˜¸ 6ê°œ</label>
            <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:0.5rem;margin-bottom:0.75rem">
                {% for i in range(1,7) %}
                <input type="number" name="actual_num{{ i }}" required min="1" max="45"
                       placeholder="{{ i }}" style="text-align:center">
                {% endfor %}
            </div>

            <div class="form-group">
                <label class="form-label">ë³´ë„ˆìŠ¤ ë²ˆí˜¸ (ì„ íƒ)</label>
                <input type="number" name="bonus" min="1" max="45" placeholder="ë³´ë„ˆìŠ¤">
            </div>

            <button type="submit" class="btn btn-gold" style="width:100%">
                <i class="fas fa-save"></i> ë‹¹ì²¨ ë²ˆí˜¸ ì €ì¥
            </button>
        </form>
    </div>

    <!-- ì˜ˆì¸¡ ë²ˆí˜¸ ì…ë ¥ -->
    <div class="card">
        <div class="card-title"><i class="fas fa-brain"></i> Step 2: ì˜ˆì¸¡ ë²ˆí˜¸ ì…ë ¥</div>
        <form action="/input/predictions" method="POST">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                <div class="form-group">
                    <label class="form-label">íšŒì°¨ ë²ˆí˜¸</label>
                    <input type="number" name="pred_round_number" id="predRound" required min="1"
                           placeholder="1210" onchange="checkRoundStatus()">
                </div>
                <div class="form-group">
                    <label class="form-label">ì½”ë“œ ì„ íƒ</label>
                    <select name="code_id" id="codeSelect" onchange="updateSetInfo()">
                        {% for cid, c in codes.items() %}
                        <option value="{{ cid }}">{{ cid }} {{ c.name }} ({{ c.sets }}ì„¸íŠ¸)</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- ì…ë ¥ ìƒíƒœ í‘œì‹œ -->
            <div id="roundStatus" style="margin-bottom:0.75rem;display:none">
                <div style="display:flex;flex-wrap:wrap;gap:0.4rem" id="statusBadges"></div>
            </div>

            <div class="form-group">
                <label class="form-label">
                    ì˜ˆì¸¡ ë²ˆí˜¸ (<span id="setCount">5</span>ì„¸íŠ¸, í•œ ì¤„ì— 6ê°œ ìˆ«ì)
                </label>
                <textarea name="prediction_text" id="predText" required
                    placeholder="ê° ì½”ë“œ ì‹¤í–‰ í›„ [ê°„í¸ ëª¨ë“œ] ì¶œë ¥ì„ ë³µì‚¬ ë¶™ì—¬ë„£ê¸°í•˜ì„¸ìš”&#10;&#10;ì˜ˆì‹œ:&#10;3, 15, 19, 27, 37, 38&#10;6, 11, 12, 26, 32, 40&#10;3, 9, 30, 34, 37, 40&#10;3, 6, 12, 18, 30, 38&#10;3, 7, 24, 26, 33, 37"></textarea>
            </div>

            <div style="display:flex;gap:0.75rem">
                <button type="submit" class="btn btn-gold" style="flex:1">
                    <i class="fas fa-paper-plane"></i> ì˜ˆì¸¡ ë²ˆí˜¸ ì €ì¥
                </button>
                <button type="button" class="btn btn-outline" onclick="validateInput()">
                    <i class="fas fa-check"></i> ê²€ì¦
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ìµœê·¼ ë“±ë¡ íšŒì°¨ -->
{% if rounds %}
<div class="card" style="margin-top:1.5rem">
    <div class="card-title"><i class="fas fa-list"></i> ìµœê·¼ ë“±ë¡ íšŒì°¨</div>
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>íšŒì°¨</th>
                    <th>ì¶”ì²¨ì¼</th>
                    <th>ë‹¹ì²¨ ë²ˆí˜¸</th>
                    <th>ë“±ë¡ ì½”ë“œ</th>
                </tr>
            </thead>
            <tbody>
                {% for r in rounds[:5] %}
                <tr>
                    <td><strong>{{ r.round_number }}</strong>íšŒ</td>
                    <td style="color:var(--text-muted)">{{ r.draw_date or '-' }}</td>
                    <td>
                        {% for i in range(1,7) %}
                        {% set n = r['num' ~ i] %}
                        <span class="lotto-ball {% if n <= 10 %}z1{% elif n <= 20 %}z2{% elif n <= 30 %}z3{% elif n <= 40 %}z4{% else %}z5{% endif %}" style="width:28px;height:28px;font-size:0.72rem">
                            {{ n }}
                        </span>
                        {% endfor %}
                    </td>
                    <td>
                        <a href="/round/{{ r.round_number }}" class="btn btn-outline btn-sm">
                            <i class="fas fa-search"></i> ìƒì„¸
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
const CODES = {
    {% for cid, c in codes.items() %}
    '{{ cid }}': {name:'{{ c.name }}', sets:{{ c.sets }}, color:'{{ c.color }}', short:'{{ c.short }}'},
    {% endfor %}
};

function updateSetInfo() {
    const cid = document.getElementById('codeSelect').value;
    document.getElementById('setCount').textContent = CODES[cid].sets;
}

async function checkRoundStatus() {
    const rn = document.getElementById('predRound').value;
    if (!rn) return;
    try {
        const res = await fetch(`/api/round/${rn}/status`);
        const data = await res.json();
        const container = document.getElementById('roundStatus');
        const badges = document.getElementById('statusBadges');
        if (!data.exists) {
            container.style.display = 'block';
            badges.innerHTML = '<span style="color:#f87171;font-size:0.82rem">âš ï¸ ì´ íšŒì°¨ê°€ ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</span>';
            return;
        }
        container.style.display = 'block';
        let html = '';
        for (const [cid, info] of Object.entries(CODES)) {
            const status = data.codes[cid];
            const entered = status && status.entered;
            html += `<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;font-size:0.75rem;font-family:'JetBrains Mono';background:${entered ? 'rgba(34,197,94,0.12)' : 'rgba(239,68,68,0.08)'};color:${entered ? '#4ade80' : '#6b7280'};border:1px solid ${entered ? 'rgba(34,197,94,0.2)' : 'rgba(107,114,128,0.2)'}">
                <span style="width:7px;height:7px;border-radius:50%;background:${info.color}"></span>
                ${info.short} ${entered ? 'âœ“' : ''}
            </span>`;
        }
        badges.innerHTML = html;
    } catch(e) {}
}

function validateInput() {
    const text = document.getElementById('predText').value.trim();
    const cid = document.getElementById('codeSelect').value;
    const expected = CODES[cid].sets;

    if (!text) { alert('ì˜ˆì¸¡ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }

    const lines = text.split('\n').filter(l => l.trim());
    let valid = 0, errors = [];

    lines.forEach((line, i) => {
        const nums = line.replace(/,/g, ' ').trim().split(/\s+/).filter(n => /^\d+$/.test(n)).map(Number);
        if (nums.length !== 6) {
            errors.push(`${i+1}ì¤„: ìˆ«ì ${nums.length}ê°œ (6ê°œ í•„ìš”)`);
        } else if (nums.some(n => n < 1 || n > 45)) {
            errors.push(`${i+1}ì¤„: ë²”ìœ„ ì´ˆê³¼`);
        } else if (new Set(nums).size !== 6) {
            errors.push(`${i+1}ì¤„: ì¤‘ë³µ ìˆìŒ`);
        } else {
            valid++;
        }
    });

    let msg = `âœ… ìœ íš¨: ${valid}ì„¸íŠ¸ / í•„ìš”: ${expected}ì„¸íŠ¸`;
    if (errors.length) msg += '\n\nâŒ ì˜¤ë¥˜:\n' + errors.join('\n');
    if (valid !== expected) msg += `\n\nâš ï¸ ${expected}ì„¸íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤`;
    alert(msg);
}
</script>
{% endblock %}
