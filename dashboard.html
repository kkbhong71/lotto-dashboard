{% extends "base.html" %}
{% block title %}ëŒ€ì‹œë³´ë“œ - ë¡œë˜ ë¶„ì„{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ“Š ì˜ˆì¸¡ ì„±ëŠ¥ ëŒ€ì‹œë³´ë“œ</h1>
    <p>7ê°œ ì•Œê³ ë¦¬ì¦˜ì˜ ëˆ„ì  ì„±ì ì„ ì‹¤ì‹œê°„ ì¶”ì í•©ë‹ˆë‹¤</p>
</div>

{% if data.total_rounds == 0 %}
<div class="empty-state">
    <i class="fas fa-database"></i>
    <h3>ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
    <p>ë¨¼ì € <a href="/input" style="color:var(--accent-gold)">ì…ë ¥ í˜ì´ì§€</a>ì—ì„œ íšŒì°¨ ë°ì´í„°ë¥¼ ë“±ë¡í•˜ì„¸ìš”</p>
</div>
{% else %}

<!-- ìš”ì•½ í†µê³„ ì¹´ë“œ -->
<div class="grid-4" style="margin-bottom:1.5rem">
    <div class="card">
        <div class="card-title"><i class="fas fa-calendar"></i> ì´ íšŒì°¨</div>
        <div class="stat-value">{{ data.total_rounds }}</div>
        <div class="stat-label">ë“±ë¡ëœ ì¶”ì²¨ íšŒì°¨</div>
    </div>
    <div class="card">
        <div class="card-title"><i class="fas fa-trophy"></i> ìµœê³  ì„±ì </div>
        {% if data.code_rankings %}
        <div class="stat-value" style="color:{{ data.code_rankings[0].color }}">
            {{ data.code_rankings[0].short }}
        </div>
        <div class="stat-label">{{ data.code_rankings[0].name }} (í‰ê·  {{ data.code_rankings[0].avg_max_match }}ê°œ)</div>
        {% else %}
        <div class="stat-value">-</div>
        {% endif %}
    </div>
    <div class="card">
        <div class="card-title"><i class="fas fa-bullseye"></i> ìµœë‹¤ 3+ì¼ì¹˜</div>
        {% set best3 = data.code_rankings|sort(attribute='pct_3plus', reverse=True)|first if data.code_rankings else None %}
        {% if best3 %}
        <div class="stat-value">{{ best3.pct_3plus }}%</div>
        <div class="stat-label">{{ best3.name }}</div>
        {% else %}
        <div class="stat-value">-</div>
        {% endif %}
    </div>
    <div class="card">
        <div class="card-title"><i class="fas fa-star"></i> 4+ì¼ì¹˜ íšŸìˆ˜</div>
        {% set total4 = data.code_rankings|sum(attribute='match_4plus') if data.code_rankings else 0 %}
        <div class="stat-value">{{ total4 }}</div>
        <div class="stat-label">ì „ì²´ ì½”ë“œ í•©ì‚°</div>
    </div>
</div>

<!-- ë­í‚¹ í…Œì´ë¸” + ì„±ê³¼ ê·¸ë˜í”„ -->
<div class="grid-2" style="margin-bottom:1.5rem">
    <!-- ë­í‚¹ í…Œì´ë¸” -->
    <div class="card">
        <div class="card-title"><i class="fas fa-medal"></i> ì½”ë“œë³„ ëˆ„ì  ë­í‚¹</div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ì½”ë“œ</th>
                        <th>íšŒì°¨</th>
                        <th>í‰ê· ìµœëŒ€</th>
                        <th>3+ì¼ì¹˜</th>
                        <th>4+</th>
                        <th>vs ëœë¤</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in data.code_rankings %}
                    <tr>
                        <td>
                            <span class="rank-badge {% if r.rank==1 %}rank-1{% elif r.rank==2 %}rank-2{% elif r.rank==3 %}rank-3{% else %}rank-other{% endif %}">
                                {{ r.rank }}
                            </span>
                        </td>
                        <td>
                            <span class="code-dot" style="background:{{ r.color }}"></span>
                            <strong>{{ r.short }}</strong>
                            <span style="color:var(--text-muted);font-size:0.78rem;margin-left:4px">{{ r.name }}</span>
                        </td>
                        <td style="font-family:'JetBrains Mono';font-size:0.85rem">{{ r.rounds }}</td>
                        <td>
                            <span style="font-family:'JetBrains Mono';font-weight:700;font-size:1.05rem;color:{{ r.color }}">
                                {{ r.avg_max_match }}
                            </span>
                        </td>
                        <td style="font-family:'JetBrains Mono';font-size:0.85rem">{{ r.pct_3plus }}%</td>
                        <td style="font-family:'JetBrains Mono';font-size:0.85rem">{{ r.match_4plus }}</td>
                        <td>
                            <span class="stat-change {% if r.vs_random > 0 %}positive{% else %}negative{% endif %}">
                                {{ '+' if r.vs_random > 0 }}{{ r.vs_random }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ëœë¤ ëŒ€ë¹„ ì„±ê³¼ ê·¸ë˜í”„ -->
    <div class="card">
        <div class="card-title"><i class="fas fa-chart-line"></i> ìµœëŒ€ì¼ì¹˜ ì¶”ì´ (vs ëœë¤)</div>
        <canvas id="performanceChart" style="max-height:350px"></canvas>
    </div>
</div>

<!-- ë²ˆí˜¸ ëŒ€ì—­ë³„ íˆíŠ¸ë§µ -->
<div class="card" style="margin-bottom:1.5rem">
    <div class="card-title"><i class="fas fa-th"></i> ë²ˆí˜¸ ëŒ€ì—­ë³„ ì˜ˆì¸¡ ë¶„í¬ íˆíŠ¸ë§µ</div>
    <canvas id="heatmapChart" style="max-height:320px"></canvas>
</div>

{% endif %}
{% endblock %}

{% block extra_js %}
{% if data.total_rounds > 0 %}
<script>
const dashData = {{ data_json|safe }};
const CODES = {
    {% for cid, c in codes.items() %}
    '{{ cid }}': {name:'{{ c.name }}', color:'{{ c.color }}', short:'{{ c.short }}', sets:{{ c.sets }}},
    {% endfor %}
};

// â”€â”€ ì„±ê³¼ ì¶”ì´ ë¼ì¸ ì°¨íŠ¸ â”€â”€
(function() {
    const ctx = document.getElementById('performanceChart');
    if (!ctx) return;

    const datasets = [];

    // ì½”ë“œë³„ ë¼ì¸
    for (const [cid, info] of Object.entries(CODES)) {
        const series = dashData.performance_series[cid];
        if (!series || series.every(v => v === null)) continue;
        datasets.push({
            label: info.short,
            data: series,
            borderColor: info.color,
            backgroundColor: info.color + '20',
            borderWidth: 2,
            pointRadius: series.length > 20 ? 0 : 3,
            pointHoverRadius: 5,
            tension: 0.3,
            spanGaps: true,
        });
    }

    // ëœë¤ 5ì„¸íŠ¸ ê¸°ì¤€ì„ 
    if (dashData.random_series.rand5_avg) {
        datasets.push({
            label: 'ëœë¤5',
            data: dashData.random_series.rand5_avg,
            borderColor: '#4b5563',
            borderDash: [6, 4],
            borderWidth: 1.5,
            pointRadius: 0,
            tension: 0.3,
            spanGaps: true,
        });
    }

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dashData.round_labels,
            datasets: datasets,
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: {
                    labels: { color: '#8896b0', font: { family: "'JetBrains Mono'" , size: 11 } }
                },
                tooltip: {
                    backgroundColor: '#1a2236',
                    borderColor: '#2a3654',
                    borderWidth: 1,
                    titleFont: { family: "'JetBrains Mono'" },
                    bodyFont: { family: "'JetBrains Mono'", size: 12 },
                }
            },
            scales: {
                x: {
                    ticks: { color: '#5a6a85', font: { family: "'JetBrains Mono'", size: 10 }, maxRotation: 45 },
                    grid: { color: '#1a2236' },
                },
                y: {
                    min: 0,
                    max: 6,
                    ticks: {
                        color: '#5a6a85',
                        font: { family: "'JetBrains Mono'", size: 11 },
                        stepSize: 1,
                        callback: v => v + 'ê°œ',
                    },
                    grid: { color: '#1f2a42' },
                }
            }
        }
    });
})();

// â”€â”€ ë²ˆí˜¸ ëŒ€ì—­ íˆíŠ¸ë§µ (ê°€ë¡œ ë°” ê·¸ë£¹) â”€â”€
(function() {
    const ctx = document.getElementById('heatmapChart');
    if (!ctx) return;

    const zones = ['1~10', '11~20', '21~30', '31~40', '41~45'];
    const datasets = [];

    for (const [cid, info] of Object.entries(CODES)) {
        const zoneData = dashData.zone_heatmap[cid];
        if (!zoneData) continue;
        const hasData = Object.values(zoneData).some(v => v > 0);
        if (!hasData) continue;
        datasets.push({
            label: info.short,
            data: zones.map(z => zoneData[z] || 0),
            backgroundColor: info.color + 'CC',
            borderColor: info.color,
            borderWidth: 1,
            borderRadius: 4,
        });
    }

    // ì´ë¡ ì  ê· ë“± ë¶„í¬
    const idealDist = [22.2, 22.2, 22.2, 22.2, 11.1]; // 10+10+10+10+5 out of 45
    datasets.push({
        label: 'ì´ë¡ ë¶„í¬',
        data: idealDist,
        backgroundColor: '#4b556340',
        borderColor: '#4b5563',
        borderWidth: 1,
        borderDash: [4, 4],
        borderRadius: 4,
    });

    new Chart(ctx, {
        type: 'bar',
        data: { labels: zones, datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#8896b0', font: { family: "'JetBrains Mono'", size: 11 } } },
                tooltip: {
                    backgroundColor: '#1a2236',
                    callbacks: { label: item => `${item.dataset.label}: ${item.raw}%` }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#8896b0', font: { family: "'JetBrains Mono'", size: 12 } },
                    grid: { display: false },
                },
                y: {
                    ticks: { color: '#5a6a85', font: { family: "'JetBrains Mono'" }, callback: v => v + '%' },
                    grid: { color: '#1f2a42' },
                }
            }
        }
    });
})();
</script>
{% endif %}
{% endblock %}
